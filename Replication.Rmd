---
title: "Replication Challenge"
author: "Lisa Philine Krämer"
date: "2025-11-20"
output: html_document
---
```{r}
library(tidyverse)
library(haven)
library(ggplot2)
library(dplyr)
library(plotly)
library(tidyr)
library(xtable)
library(knitr)
library(kableExtra)
library(tidybayes)
library(brms)
library(bayesplot)
library(posterior)
library(dagitty)
library(ggdag)

```

```{r}
#Lourenco: Was ist das?
#mean(is.na(data$opp_crowd)) * 100
```


```{r}
data <- read_dta("original&computed_DB_forrep.dta")
```

```{r}
# sort the columns to be alphabetically ordered
data <- data[, order(names(data))]

# change dates to Date type 
data$bdate <- as.Date(data$bdate, format = "%Y-%m-%d")
data$joineddate <- as.Date(data$joineddate, format = "%Y-%m-%d")
```

```{r}
summary(data)
```

```{r}
data %>%
  keep(is.numeric) %>%                     # Keep only numeric columns
  gather() %>%                             # Convert to key-value pairs
  ggplot(aes(value)) +                     # Plot the values
    facet_wrap(~ key, scales = "free") +   # In separate panels
    geom_histogram() 
```



```{r}
# Count of NAs per column
colSums(is.na(data))

# Percentage of missing values
colSums(is.na(data)) / nrow(data) * 100

```

```{r}
#plot every variable's histogram, since all data is either numeric or date

all_vars <- names(data)

for (v in all_vars) {
  print(
    ggplot(data, aes_string(x = v)) +
      geom_histogram(bins = 30) +
      ggtitle(paste("Histogram of", v))
  )
}


```
```{r}
# heatmap


# make a numeric-only version of your data:
data_num <- data %>%
  mutate(across(
    where(~ inherits(.x, "Date")),  # <- predicate: is it a Date?
    as.numeric
  ))

# calculate correlations
cor_mat <- cor(data_num, use = "pairwise.complete.obs", method = "pearson")

library(plotly)

# custom red–white–blue colorscale: blue (negative) → white (0) → red (positive)
rwb_scale <- list(
  list(0.0, "blue"),
  list(0.5, "white"),
  list(1.0, "red")
)

plot_ly(
  x = colnames(cor_mat),
  y = rownames(cor_mat),
  z = cor_mat,
  type = "heatmap",
  zmin = -1,
  zmax = 1,
  colorscale = rwb_scale,
  hovertemplate = paste(
    "Var1: %{x}<br>",
    "Var2: %{y}<br>",
    "Correlation: %{z:.2f}<extra></extra>"
  )
) %>%
  layout(
    title = list(
      text = "Pearson Correlation Heatmap",
      x = 0.5,
      xanchor = "center"
    ),
    xaxis = list(
      title = "",
      tickangle = -45,
      tickfont = list(size = 9)
    ),
    yaxis = list(
      title = "",
      tickfont = list(size = 9,
                      automargin = TRUE)
    ),
    margin = list(l = 80, r = 20, b = 120, t = 50),
    coloraxis = list(
      colorbar = list(
        title = "r",
        ticksuffix = "",
        len = 0.8
      )
    )
  )


```

Table 1
```{r}
#Panel A: Section Level
Full_Sections <- round(mean(data$dfullsection),2)
Overtime_Sections <- round(mean(data$section %in% c(10, 20)),2)
Players_Distance <-
Players_Sprints <-
SMGP <- 
Team_Distance <-
Observations1 <- nrow(data)
Observations2 <-

#Panel B



#
Rounds <- n_distinct(data$played)
Games <- n_distinct(data$gamenu)
Teams <- n_distinct(data$team)
Players <- n_distinct(data$player)
Strikers <- n_distinct(data$player[data$position == 4])
Midfielders <- n_distinct(data$player[data$position == 3])
Defenders <- n_distinct(data$player[data$position == 2])

```

#Table 2
```{r}
#daten neu laden weil positions variable weg ist
data <- read_dta("original&computed_DB_forrep.dta")
```

```{r}
#preparation 
library(dplyr)
library(tidyr)
library(brms)
```


##Prepare Data Sets
```{r}
data_base <- data %>%
  filter(
    dfullsection == 1,          # full sections only
    position %in% c(3, 4),      # midfielders + strikers
    !(section %in% c(10, 20)) 
  )
data_base <- data_base  %>% mutate(player = factor(player),
                                    gamenu = factor(gamenu),
                                    section = factor(section))
```

## DAGs
```{r}
dag1 <- dagitty("dag{
                S -> G
                NoS -> G
                NoS -> S 
                E -> S
                E -> NoS}")

coordinates(dag1) <- list( 
                          x = c(S = 0, NoS = 1, G = 2, E = 0) , 
                          y = c(S = 0, NoS = 1, G = 0, E = 1))

ggdag( dag1 ) + 
  ggtitle( "(1) Effort influences Speed & Number of Sprints;\n(2) Speed influences Goal Probability;\n(3) Number of Sprints influences Speed & Goal Probability" ) +
  theme_dag()



dag2 <- dagitty("dag{
                D -> W
                OD -> W
                }")

coordinates(dag2) <- list( 
                          x = c(D = 0, OD = 2, W = 1) , 
                          y = c(D = 0, OD = 0, W = 0))

ggdag( dag2 ) + 
  ggtitle( "(1) Team Distance influences Team Winning Probability;\n(2) Opponent Distance influences Team Winning Probability" ) +
  theme_dag()
```
```{r}
library(fixest)

reg1 <- feols(dplagoal ~ plaavspeed, data = data_base)
reg2 <- feols(dplagoal ~ playersprints, data = data_base)
reg3 <- feols(dplagoal ~ plaavspeed + playersprints, data = data_base)
reg4 <- feols(plaavspeed ~ playersprints, data = data_base)

etable(reg1, reg2, reg3, reg4)

```



## Summary Statistics

Define missing variable

```{r}
data_base <- data_base %>%
  mutate(
    SMGP = ifelse(position %in% c(3,4),          # SMGP = Strikers and midfielders goal probability
                  dplagoal,                      # already 0/1 if player scored
                  NA)                            # set others to NA
  )
```

```{r}
# unique combinations of team and games
TG_combinations <- data_base %>%
     distinct(team, gamenu) %>%
     nrow()
 
TG_combinations
```

```{r}
team_game_redcards <- data_base %>%
  group_by(team, gamenu) %>%
  summarise(
    redcard_teamgame = as.integer(any(dplaredc == 1)),
    .groups = "drop"
  )

```



```{r}
### --------------------------------------------------------------
### PANEL A: Section level
### --------------------------------------------------------------

panelA_vars <- list(
  full_sections                = "dfullsection",
  overtime_sections            = "(data$section %in% c(10, 20)),2)",
  player_distance              = "playerdist",
  player_sprints               = "playersprints",
  goal_probability             = "SMGP",
  team_distance                = "teamdist"
)

panelA <- data_base %>% 
  summarise(
    FullSections_mean     = mean(dfullsection, na.rm = TRUE),
    Overtime_mean         = round(mean(data$section %in% c(10, 20)),2),
    PlayerDistance_mean   = mean(playerdist, na.rm = TRUE),
    PlayerDistance_sd     = sd(playerdist, na.rm = TRUE),
    PlayerSprints_mean    = mean(playersprints, na.rm = TRUE),
    PlayerSprints_sd      = sd(playersprints, na.rm = TRUE),
    GoalProb_mean         = mean(SMGP, na.rm = TRUE),
    GoalProb_sd           = sd(SMGP, na.rm = TRUE),
    TeamDistance_mean     = mean(teamdist, na.rm = TRUE),
    TeamDistance_sd       = sd(teamdist, na.rm = TRUE),
    Observations_PS       = nrow(data_base),
    Observations_TS       = TG_combinations*20         #18 oder 20?
  )

options(scipen = 999)
panelA <- panelA %>%
  pivot_longer(
    cols = everything(),
    names_to = "Variable",
    values_to = "Value"
  )
 
```

```{r}


dataB <- data %>%
  filter(dfullsection == 1 & !(section %in% c(10))) %>%
  group_by(gamenu, player) %>%
  summarise(
    player_sectionsplayed = first(player_sectionsplayed),  
    player_avg_speed      = mean(plaavspeed_game, na.rm = TRUE),
    .groups = "drop"
  )

dataB2 <- data %>%
  filter(dfullsection == 1 & !(section %in% c(10))) %>%
  group_by(gamenu, team) %>%
  summarise(
    teamdist_game = mean(teamdist_game, na.rm = TRUE)
  )

crowd_game <- data %>%
  group_by(gamenu, team, dhomegame) %>%  
  summarise(
    home_crowd = first(team_crowd),
    opp_crowd  = first(opp_crowd),
    .groups = "drop"
  )

redcard <- data %>%
  group_by(gamenu) %>%
  summarise(
    any_red = max(dplaredc, na.rm = TRUE),  
    .groups = "drop"
  )



```



```{r}
### --------------------------------------------------------------
### PANEL B: Game level
### --------------------------------------------------------------

panelB <- data %>% 
  summarise(
    SectionsPlayed_mean   = mean(dataB$player_sectionsplayed, na.rm = TRUE),
    SectionsPlayed_sd     = sd(dataB$player_sectionsplayed, na.rm = TRUE),
    AvgSpeed_mean         = mean(dataB$player_avg_speed, na.rm = TRUE),
    AvgSpeed_sd           = sd(dataB$player_avg_speed, na.rm = TRUE),
    TeamDistanceGame_mean = mean(dataB2$teamdist_game, na.rm = TRUE),
    TeamDistanceGame_sd   = sd(dataB2$teamdist_game, na.rm = TRUE),
    HomeCrowd_mean        = mean(crowd_game$home_crowd[crowd_game$dhomegame == 1], na.rm = TRUE),
    HomeCrowd_sd          = sd(crowd_game$home_crowd[crowd_game$dhomegame == 1], na.rm = TRUE),
    AwayCrowd_mean        = mean(crowd_game$opp_crowd[crowd_game$dhomegame == 1], na.rm = TRUE),
    AwayCrowd_sd          = sd(crowd_game$opp_crowd[crowd_game$dhomegame == 1], na.rm = TRUE),
    RedCardProb_mean      = mean(redcard$any_red, na.rm = TRUE),
    RedCardProb_sd        = sd(redcard$any_red, na.rm = TRUE),
    Obs_player_game       = data %>% 
  filter(dfullsection == 1 & !(section %in% c(10))) %>%
  distinct(gamenu, player) %>% nrow(),
    Obs_team_game         = n_distinct(team, gamenu),
    
    Rounds                = n_distinct(played),
    Games                 = n_distinct(gamenu),
    Teams                 = n_distinct(team),
    Players               = n_distinct(player),
    Strikers              = n_distinct(data$player[data$position == 4]),
    Midfielders           = n_distinct(data$player[data$position == 3]),
    Defenders             = n_distinct(data$player[data$position == 2])
  )

panelB <- panelB %>%
  pivot_longer(
    cols = everything(),
    names_to = "Variable",
    values_to = "Value"
  )
```

## Latex code for summary statistics
```{r}
### PANEL A Latex code
panelA_latex <- kable(panelA, 
                      format = "latex", 
                      booktabs = TRUE, 
                      caption = "Panel A: Section LeveL") %>%
  kable_styling(latex_options = c("hold_position", "scale_down"))

# Print Latex code
cat(panelA_latex)

### PANEL B Latex code
panelB_latex <- kable(panelB, 
                      format = "latex", 
                      booktabs = TRUE, 
                      caption = "Panel B: Game Level") %>%
  kable_styling(latex_options = c("hold_position", "scale_down"))

# Print Latex code
cat(panelB_latex)
```




##Intercept-only model
```{r}
m_intercept <- brm(
  dplagoal ~ 1, 
  data    = data_base,
  family  = bernoulli(link = "logit"),
  #sample_prior = "only",
  prior = prior( normal(0, 3.5), class = Intercept),      
  iter    = 2000, warmup = 1000, chains = 4, cores = 4
)

pp_check(m_intercept)
summary(m_intercept)


posterior_samples( m_intercept ) %>% 
  transmute( alpha = inv_logit_scaled( b_Intercept )) %>% 
  mean_qi()
```






```{r}
data_col1 <- data_base %>%
  drop_na(dplagoal, plaavspeed) %>%
  mutate(
    plaavspeed_c = plaavspeed - mean(plaavspeed, na.rm = TRUE)
  )
```

```{r}
data_col2 <- data_base %>%
  drop_na(
    dplagoal, plaavspeed,
    dhomegame, rank_gap,
    player_cumsections, player_cumsections_2
  ) %>%
  mutate(
    plaavspeed_c           = plaavspeed - mean(plaavspeed, na.rm = TRUE),
    rank_gap_c             = rank_gap - mean(rank_gap, na.rm = TRUE),
    player_cumsections_c   = player_cumsections - mean(player_cumsections, na.rm = TRUE),
    player_cumsections_2_c = player_cumsections_2 - mean(player_cumsections_2, na.rm = TRUE)
  )

```

```{r}
data_col356 <- data_base %>%
  drop_na(
    dplagoal, plaavspeed, playersprints,
    dhomegame, rank_gap,
    player_cumsections, player_cumsections_2,
    scoregap_pre, dteamgoal_pre, dplagoal_pre,
    dteamred_pre, dteaminj_sec_pre,
    team_avespeed_pre
  ) %>%
  mutate(
    plaavspeed_c           = plaavspeed - mean(plaavspeed, na.rm = TRUE),
    playersprints_c        = playersprints - mean(playersprints, na.rm = TRUE),
    rank_gap_c             = rank_gap - mean(rank_gap, na.rm = TRUE),
    player_cumsections_c   = player_cumsections - mean(player_cumsections, na.rm = TRUE),
    player_cumsections_2_c = player_cumsections_2 - mean(player_cumsections_2, na.rm = TRUE),
    scoregap_pre_c         = scoregap_pre - mean(scoregap_pre, na.rm = TRUE),
    team_avespeed_pre_c    = team_avespeed_pre - mean(team_avespeed_pre, na.rm = TRUE)
  )
```

```{r}
data_col4 <- data_base %>%
  drop_na(
    dplagoal, plaavspeed,
    dhomegame, rank_gap,
    player_cumsections, player_cumsections_2,
    scoregap_pre, dteamgoal_pre, dplagoal_pre,
    dteamred_pre, dteaminj_sec_pre,
    team_avespeed_pre,
    team_crowd, opp_crowd,
    p_odds_team, p_odds_draw
  ) %>%
  mutate(
    plaavspeed_c           = plaavspeed - mean(plaavspeed, na.rm = TRUE),
    rank_gap_c             = rank_gap - mean(rank_gap, na.rm = TRUE),
    player_cumsections_c   = player_cumsections - mean(player_cumsections, na.rm = TRUE),
    player_cumsections_2_c = player_cumsections_2 - mean(player_cumsections_2, na.rm = TRUE),
    scoregap_pre_c         = scoregap_pre - mean(scoregap_pre, na.rm = TRUE),
    team_avespeed_pre_c    = team_avespeed_pre - mean(team_avespeed_pre, na.rm = TRUE),
    team_crowd_c           = team_crowd - mean(team_crowd, na.rm = TRUE),
    opp_crowd_c            = opp_crowd - mean(opp_crowd, na.rm = TRUE),
    p_odds_team_c          = p_odds_team - mean(p_odds_team, na.rm = TRUE),
    p_odds_draw_c          = p_odds_draw - mean(p_odds_draw, na.rm = TRUE)
  )

```

```{r}
# player × game data for column 7 (as in the paper)
data_col7 <- data %>%
  # same sample restrictions as Table 2
  filter(
    position %in% c(3, 4),         # only midfielders and strikers
    !(section %in% c(10, 20))      # drop overtime sections
  ) %>%
  group_by(player, gamenu) %>%
  summarise(
    # outcome: at least one goal by this player in this game
    goal_game        = as.integer(any(dplagoal == 1)),

    # main regressor: game-average speed of the player
    plaavspeed_game  = first(plaavspeed_game),

    # controls that are constant within a game for that player
    dhomegame        = first(dhomegame),
    rank_gap         = first(rank_gap),

    .groups = "drop"
  ) %>%
  # drop missing info (e.g. if some game-level variable is NA)
  drop_na(goal_game, plaavspeed_game, dhomegame, rank_gap) %>%
  # centering (like in the other columns)
  mutate(
    plaavspeed_game_c = plaavspeed_game - mean(plaavspeed_game, na.rm = TRUE),
    rank_gap_c        = rank_gap - mean(rank_gap, na.rm = TRUE),
    # factors for player and game fixed/random effects
    player            = factor(player),
    gamenu            = factor(gamenu)
  )

```

```{r}
#check if n matches table
nrow(data_col1)
nrow(data_col2)
nrow(data_col356) #unterschieded sich um 2, müsste aber eig gleich sein
nrow(data_col4)
nrow(data_col7) #hier fehlen 14, verstehe nicht warum
```

```{r}
## Fixed-effects priors (for models with factor(player), factor(gamenu), factor(section))
## Designed to be as close as possible in scale to the hierarchical setup.

## 1) Base priors: used for columns 1–6
priors_fixef_base <- c(
  # same intercept prior as hierarchical cols 1–6
  set_prior("normal(-4.6, 0.3)", class = "Intercept"),
  # default for all coefficients (incl. factor dummies), unless overridden below
  set_prior("normal(0, 0.4)",   class = "b")
)

## 2) Column-specific priors: base + explicit priors for every covariate in that column

### Column 1: dplagoal ~ plaavspeed_c + factor(player) + factor(gamenu) + factor(section)
priors_fixef_col1 <- c(
  priors_fixef_base,
  set_prior("normal(0, 0.4)", class = "b", coef = "plaavspeed_c")
)

### Column 2: add dhomegame, rank_gap_c, player_cumsections_c, player_cumsections_2_c
priors_fixef_col2 <- c(
  priors_fixef_base,
  set_prior("normal(0, 0.4)", class = "b", coef = "plaavspeed_c"),
  set_prior("normal(0, 0.4)", class = "b", coef = "dhomegame"),
  set_prior("normal(0, 0.4)", class = "b", coef = "rank_gap_c"),
  set_prior("normal(0, 0.4)", class = "b", coef = "player_cumsections_c"),
  set_prior("normal(0, 0.4)", class = "b", coef = "player_cumsections_2_c")
)

### Column 3: add pre-match / lagged controls
### dplagoal ~ plaavspeed_c + dhomegame + rank_gap_c + player_cumsections_c + player_cumsections_2_c +
###             scoregap_pre_c + dteamgoal_pre + dplagoal_pre + dteamred_pre + dteaminj_sec_pre +
###             team_avespeed_pre_c + factors
priors_fixef_col3 <- c(
  priors_fixef_base,
  set_prior("normal(0, 0.4)", class = "b", coef = "plaavspeed_c"),
  set_prior("normal(0, 0.4)", class = "b", coef = "dhomegame"),
  set_prior("normal(0, 0.4)", class = "b", coef = "rank_gap_c"),
  set_prior("normal(0, 0.4)", class = "b", coef = "player_cumsections_c"),
  set_prior("normal(0, 0.4)", class = "b", coef = "player_cumsections_2_c"),
  set_prior("normal(0, 0.4)", class = "b", coef = "scoregap_pre_c"),
  set_prior("normal(0, 0.4)", class = "b", coef = "dteamgoal_pre"),
  set_prior("normal(0, 0.4)", class = "b", coef = "dplagoal_pre"),
  set_prior("normal(0, 0.4)", class = "b", coef = "dteamred_pre"),
  set_prior("normal(0, 0.4)", class = "b", coef = "dteaminj_sec_pre"),
  set_prior("normal(0, 0.4)", class = "b", coef = "team_avespeed_pre_c")
)

### Column 4: plus crowd & betting odds
### dplagoal ~ plaavspeed_c + ... + team_crowd_c + opp_crowd_c + p_odds_team_c + p_odds_draw_c + factors
priors_fixef_col4 <- c(
  priors_fixef_col3,  # all priors from col3 +
  set_prior("normal(0, 0.4)", class = "b", coef = "team_crowd_c"),
  set_prior("normal(0, 0.4)", class = "b", coef = "opp_crowd_c"),
  set_prior("normal(0, 0.4)", class = "b", coef = "p_odds_team_c"),
  set_prior("normal(0, 0.4)", class = "b", coef = "p_odds_draw_c")
)

### Column 5: sprint effort instead of plaavspeed_c
### dplagoal ~ playersprints_c + same controls as col3 + factors
priors_fixef_col5 <- c(
  priors_fixef_base,
  set_prior("normal(0, 0.4)", class = "b", coef = "playersprints_c"),
  set_prior("normal(0, 0.4)", class = "b", coef = "dhomegame"),
  set_prior("normal(0, 0.4)", class = "b", coef = "rank_gap_c"),
  set_prior("normal(0, 0.4)", class = "b", coef = "player_cumsections_c"),
  set_prior("normal(0, 0.4)", class = "b", coef = "player_cumsections_2_c"),
  set_prior("normal(0, 0.4)", class = "b", coef = "scoregap_pre_c"),
  set_prior("normal(0, 0.4)", class = "b", coef = "dteamgoal_pre"),
  set_prior("normal(0, 0.4)", class = "b", coef = "dplagoal_pre"),
  set_prior("normal(0, 0.4)", class = "b", coef = "dteamred_pre"),
  set_prior("normal(0, 0.4)", class = "b", coef = "dteaminj_sec_pre"),
  set_prior("normal(0, 0.4)", class = "b", coef = "team_avespeed_pre_c")
)

### Column 6: both plaavspeed_c and playersprints_c + same controls as col5
priors_fixef_col6 <- c(
  priors_fixef_base,
  set_prior("normal(0, 0.4)", class = "b", coef = "plaavspeed_c"),
  set_prior("normal(0, 0.4)", class = "b", coef = "playersprints_c"),
  set_prior("normal(0, 0.4)", class = "b", coef = "dhomegame"),
  set_prior("normal(0, 0.4)", class = "b", coef = "rank_gap_c"),
  set_prior("normal(0, 0.4)", class = "b", coef = "player_cumsections_c"),
  set_prior("normal(0, 0.4)", class = "b", coef = "player_cumsections_2_c"),
  set_prior("normal(0, 0.4)", class = "b", coef = "scoregap_pre_c"),
  set_prior("normal(0, 0.4)", class = "b", coef = "dteamgoal_pre"),
  set_prior("normal(0, 0.4)", class = "b", coef = "dplagoal_pre"),
  set_prior("normal(0, 0.4)", class = "b", coef = "dteamred_pre"),
  set_prior("normal(0, 0.4)", class = "b", coef = "dteaminj_sec_pre"),
  set_prior("normal(0, 0.4)", class = "b", coef = "team_avespeed_pre_c")
)

## 3) Column 7: game-level model, wider priors like hierarchical priors_base_col7

priors_fixef_base_col7 <- c(
  set_prior("normal(-4.6, 1)", class = "Intercept"),  # more variation at game level
  set_prior("normal(0, 0.5)", class = "b")           # all coefficients by default
)

### Column 7: goal_game ~ plaavspeed_game_c + dhomegame + rank_gap_c + factor(player) + factor(gamenu)
priors_fixef_col7 <- c(
  priors_fixef_base_col7,
  set_prior("normal(0, 0.4)", class = "b", coef = "plaavspeed_game_c"),
  set_prior("normal(0, 0.5)", class = "b", coef = "dhomegame"),
  set_prior("normal(0, 0.5)", class = "b", coef = "rank_gap_c")
)

```


##Column 1
```{r}
m_col1_prior <- brm(
  dplagoal ~ plaavspeed_c +
    factor(player) +      
    factor(gamenu) +     
    factor(section), 
  data    = data_col1,
  family  = bernoulli(link = "logit"),
  sample_prior = "only",
  prior   = priors_fixef_col1,
  iter    = 1000, warmup = 500, chains = 4, cores = 4
)
saveRDS(m_col1_prior, "m_col1_prior.rds")
```


```{r}
#prior checks
pp_check(m_col1_prior, ndraws = 50)          
yrep_small <- posterior_predict(m_col1_prior, ndraws = 100)
hist(rowMeans(yrep_small))
plot(m_col1_prior, N = 1000)                             
```

```{r}
## POSTERIOR MODEL + LOO/WAIC
m_col1 <- brm(
  dplagoal ~ plaavspeed_c +
    factor(player) +      
    factor(gamenu) +     
    factor(section),     
  data    = data_col1,
  family  = bernoulli(link = "logit"),
  prior   = priors_fixef_col1,
  iter    = 1000, warmup = 500, chains = 4, cores = 4,
  save_pars = save_pars(all = TRUE)   # ensures log-lik etc. are stored
)

## add LOO & WAIC to the fit object
m_col1 <- add_criterion(m_col1, c("loo", "waic"))

## save model *with* criteria
saveRDS(m_col1, "m_col1.rds")
```

```{r}
summary(m_col1)
pp_check(m_col1, ndraws = 100)
conditional_effects(m_col1, spaghetti = TRUE, ndraws = 200)
plot(m_col1)
```

##Column 2

```{r}
m_col2_prior <- brm(
  dplagoal ~ plaavspeed_c +
    dhomegame +
    rank_gap_c +
    player_cumsections_c + player_cumsections_2_c +
    factor(player) +      
    factor(gamenu) +     
    factor(section), 
    sample_prior = "only",
  data    = data_col2,
  family  = bernoulli(link = "logit"),
  prior   = priors_fixef_col2,
  iter    = 1000, warmup = 500, chains = 4, cores = 4
)
saveRDS(m_col2_prior, "m_col2_prior.rds")
```

```{r}
#prior checks
pp_check(m_col2_prior, ndraws = 50)          
yrep_small2 <- posterior_predict(m_col2_prior, ndraws = 100)
hist(rowMeans(yrep_small2))
plot(m_col2_prior, N = 1000)                               
```

```{r}
m_col2 <- brm(
  dplagoal ~ plaavspeed_c +
    dhomegame +
    rank_gap_c +
    player_cumsections_c + player_cumsections_2_c +
    factor(player) +      
    factor(gamenu) +     
    factor(section), 
    #sample_prior = "only",
  data    = data_col2,
  family  = bernoulli(link = "logit"),
  prior   = priors_fixef_col2,
  iter    = 2000, warmup = 1000, chains = 4, cores = 4,
  save_pars = save_pars(all = TRUE)   # ensures log-lik etc. are stored
)

## add LOO & WAIC to the fit object
m_col2 <- add_criterion(m_col2, c("loo", "waic"))

saveRDS(m_col2, "m_col2.rds")
```

##Column 3
```{r}
m_col3 <- brm(
  dplagoal ~
    plaavspeed_c +
    dhomegame + rank_gap_c +
    player_cumsections_c + player_cumsections_2_c +
    scoregap_pre_c + dteamgoal_pre + dplagoal_pre +
    dteamred_pre + dteaminj_sec_pre +
    team_avespeed_pre_c +
    factor(player) +      
    factor(gamenu) +     
    factor(section), 
  data    = data_col356,
  family  = bernoulli(link = "logit"),
  prior   = priors_fixef_col3,
  chains  = 4, iter = 2000, warmup = 1000, cores = 4,
  save_pars = save_pars(all = TRUE)   # ensures log-lik etc. are stored
)

## add LOO & WAIC to the fit object
m_col3 <- add_criterion(m_col3, c("loo", "waic"))
```

```{r}

saveRDS(m_col3, "m_col3.rds")
```

##Column 4
```{r}
m_col4 <- brm(
  dplagoal ~
    plaavspeed_c +
    dhomegame + rank_gap_c +
    player_cumsections_c + player_cumsections_2_c +
    scoregap_pre_c + dteamgoal_pre + dplagoal_pre +
    dteamred_pre + dteaminj_sec_pre +
    team_avespeed_pre_c +
    team_crowd_c + opp_crowd_c +
    p_odds_team_c + p_odds_draw_c +
    factor(player) +      
    factor(gamenu) +     
    factor(section), 
  data    = data_col4,
  family  = bernoulli(link = "logit"),
  prior   = priors_fixef_col4,
  chains  = 4, iter = 2000, warmup = 1000, cores = 4,
  save_pars = save_pars(all = TRUE)   # ensures log-lik etc. are stored
)

## add LOO & WAIC to the fit object
m_col4 <- add_criterion(m_col4, c("loo", "waic"))
saveRDS(m_col4, "m_col4.rds")
```

##Column 5
```{r}
m_col5 <- brm(
  dplagoal ~
    playersprints_c +
    dhomegame + rank_gap_c +
    player_cumsections_c + player_cumsections_2_c +
    scoregap_pre_c + dteamgoal_pre + dplagoal_pre +
    dteamred_pre + dteaminj_sec_pre +
    team_avespeed_pre_c +
    factor(player) +      
    factor(gamenu) +     
    factor(section), 
  data    = data_col356,
  family  = bernoulli(link = "logit"),
  prior   = priors_fixef_col5,
  chains  = 4, iter = 2000, warmup = 1000, cores = 4,
  save_pars = save_pars(all = TRUE)   # ensures log-lik etc. are stored
)

## add LOO & WAIC to the fit object
m_col5 <- add_criterion(m_col5, c("loo", "waic"))
saveRDS(m_col5, "m_col5.rds")
```

##Column 6
```{r}
m_col6 <- brm(
  dplagoal ~
    plaavspeed_c + playersprints_c +
    dhomegame + rank_gap_c +
    player_cumsections_c + player_cumsections_2_c +
    scoregap_pre_c + dteamgoal_pre + dplagoal_pre +
    dteamred_pre + dteaminj_sec_pre +
    team_avespeed_pre_c +
    factor(player) +      
    factor(gamenu) +     
    factor(section), 
  data    = data_col356,
  family  = bernoulli(link = "logit"),
  prior   = priors_fixef_col6,
  chains  = 4, iter = 2000, warmup = 1000, cores = 4,
  save_pars = save_pars(all = TRUE)   # ensures log-lik etc. are stored
)

## add LOO & WAIC to the fit object
m_col6 <- add_criterion(m_col6, c("loo", "waic"))
saveRDS(m_col6, "m_col6.rds")
```

##Column 7:
```{r}
# Aggregation auf Spieler × Spiel
data_col7 <- data_base %>%
  group_by(player, gamenu) %>%
  summarise(
    # Ziel: hat der Spieler in diesem Spiel mindestens 1 Tor?
    goal_game = as.integer(any(dplagoal == 1)),

    # durchschnittliche Geschwindigkeit im Spiel
    plaavspeed_game = first(plaavspeed_game),

    # Controls, die auf Spiel-Ebene konstant sind
    dhomegame = first(dhomegame),
    rank_gap  = first(rank_gap),
    .groups = "drop"
  ) %>%
  # fehlende Werte löschen
  drop_na(goal_game, plaavspeed_game, dhomegame, rank_gap) %>%
  # Zentrierung der Prädiktoren (wie bei den anderen Spalten)
  mutate(
    plaavspeed_game_c = plaavspeed_game - mean(plaavspeed_game, na.rm = TRUE),
    rank_gap_c        = rank_gap - mean(rank_gap, na.rm = TRUE)
  )
```

```{r}
m_col7 <- brm(
  formula = goal_game ~ plaavspeed_game_c + dhomegame + rank_gap_c +
    factor(player) +      
    factor(gamenu), 
  data    = data_col7,
  family  = bernoulli(link = "logit"),
  prior   = priors_fixef_col7,
  chains  = 4, iter = 2000, warmup = 1000, cores = 4,
  save_pars = save_pars(all = TRUE)   # ensures log-lik etc. are stored
)

## add LOO & WAIC to the fit object
m_col7 <- add_criterion(m_col7, c("loo", "waic"))
saveRDS(m_col7, "m_col7.rds")
```



# hierarchical logistic models
```{r}
# Base priors
priors_base <- c(
  set_prior("normal(-4.6, 0.3)", class = "Intercept"),
  set_prior("normal(0, 0.4)", class = "sd", group = "player", lb = 0),
  set_prior("normal(0, 0.4)", class = "sd", group = "gamenu", lb = 0),
  set_prior("normal(0, 0.4)", class = "sd", group = "section", lb = 0)
)


# Column-specific priors
priors_col1 <- c(
  priors_base,
  set_prior("normal(0, 0.4)", class = "b", coef = "plaavspeed_c")
)

priors_col2 <- c(
  priors_base,
  set_prior("normal(0, 0.4)", class = "b", coef = "plaavspeed_c")
)

priors_col3 <- c(
  priors_base,
  set_prior("normal(0, 0.4)", class = "b", coef = "plaavspeed_c")
)

priors_col4 <- c(
  priors_base,
  set_prior("normal(0, 0.4)", class = "b", coef = "plaavspeed_c")
)

priors_col5 <- c(
  priors_base,
  set_prior("normal(0, 0.4)", class = "b", coef = "playersprints_c")
)

priors_col6 <- c(
  priors_base,
  set_prior("normal(0, 0.4)", class = "b", coef = "plaavspeed_c"),
  set_prior("normal(0, 0.4)", class = "b", coef = "playersprints_c")
)

priors_base_col7 <- c(
  set_prior("normal(-4.6, 1)", class = "Intercept"),
  set_prior("normal(0, 0.5)", class = "b"),
  set_prior("student_t(3, 0, 1)", class = "sd", group = "player"),
  set_prior("student_t(3, 0, 1)", class = "sd", group = "gamenu")
)

priors_col7 <- c(
  priors_base_col7,
  set_prior("normal(0, 0.4)", class = "b", coef = "plaavspeed_game_c")
)
```

```{r}
m_col1_hier_prior <- brm(
  dplagoal ~ plaavspeed_c +
    (1 | player) +        
    (1 | gamenu) +        
    (1 | section),        
  data          = data_col1,
  family        = bernoulli(link = "logit"),
  prior         = priors_col1,
  sample_prior  = "only",
  iter          = 2000, 
  warmup        = 1000,
  chains        = 4,
  cores         = 4
)
saveRDS(m_col1_hier_prior, "m_col1_hier_prior.rds")
```

```{r}
pp_check(m_col1_hier_prior, ndraws = 50)
hist(rowMeans(posterior_predict(m_col1_hier_prior, ndraws = 100)))
plot(m_col1_hier_prior)
```


```{r}
m_col1_hier <- brm(
  dplagoal ~ plaavspeed_c +
    (1 | player) +
    (1 | gamenu) +
    (1 | section),
  data         = data_col1,
  family       = bernoulli(link = "logit"),
  prior        = priors_col1,
  sample_prior = "no",
  iter         = 1000,
  warmup       = 500,
  chains       = 4,
  cores        = 4
)
saveRDS(m_col1_hier, "m_col1_hier.rds")
```

```{r}
summary(m_col1_hier)
pp_check(m_col1_hier, ndraws = 100)
conditional_effects(m_col1_hier, spaghetti = TRUE, ndraws = 200)
plot(m_col1_hier)
```

```{r}
m_col2_hier <- brm(
  dplagoal ~ plaavspeed_c +
    dhomegame +
    rank_gap_c +
    player_cumsections_c + player_cumsections_2_c +
    (1 | player) +
    (1 | gamenu) +
    (1 | section),
  data    = data_col2,
  family  = bernoulli(link = "logit"),
  prior   = priors_col2,
  chains  = 4, iter = 2000, warmup = 1000, cores = 4
)
saveRDS(m_col2_hier, "m_col2_hier.rds")
```

```{r}
summary(m_col2_hier)
pp_check(m_col2_hier, ndraws = 100)
conditional_effects(m_col2_hier, spaghetti = TRUE, ndraws = 200)
plot(m_col2_hier)
```

```{r}
m_col3_hier <- brm(
  dplagoal ~
    plaavspeed_c +
    dhomegame + rank_gap_c +
    player_cumsections_c + player_cumsections_2_c +
    scoregap_pre_c + dteamgoal_pre + dplagoal_pre +
    dteamred_pre + dteaminj_sec_pre +
    team_avespeed_pre_c +
    (1 | player) +
    (1 | gamenu) +
    (1 | section),
  data    = data_col356,
  family  = bernoulli(link = "logit"),
  prior   = priors_col3,
  chains  = 4, iter = 2000, warmup = 1000, cores = 4
)
saveRDS(m_col3_hier, "m_col3_hier.rds")
```

```{r}
summary(m_col3_hier)
pp_check(m_col3_hier, ndraws = 100)
conditional_effects(m_col3_hier, spaghetti = TRUE, ndraws = 200)
plot(m_col3_hier)
```

```{r}
m_col4_hier <- brm(
  dplagoal ~
    plaavspeed_c +
    dhomegame + rank_gap_c +
    player_cumsections_c + player_cumsections_2_c +
    scoregap_pre_c + dteamgoal_pre + dplagoal_pre +
    dteamred_pre + dteaminj_sec_pre +
    team_avespeed_pre_c +
    team_crowd_c + opp_crowd_c +
    p_odds_team_c + p_odds_draw_c +
    (1 | player) +
    (1 | gamenu) +
    (1 | section),
  data    = data_col4,
  family  = bernoulli(link = "logit"),
  prior   = priors_col4,
  chains  = 4, iter = 2000, warmup = 1000, cores = 4
)
saveRDS(m_col4_hier, "m_col4_hier.rds")
```

```{r}
summary(m_col4_hier)
pp_check(m_col4_hier, ndraws = 100)
conditional_effects(m_col4_hier, spaghetti = TRUE, ndraws = 200)
plot(m_col4_hier)
```

```{r}
m_col5_hier <- brm(
  dplagoal ~
    playersprints_c +
    dhomegame + rank_gap_c +
    player_cumsections_c + player_cumsections_2_c +
    scoregap_pre_c + dteamgoal_pre + dplagoal_pre +
    dteamred_pre + dteaminj_sec_pre +
    team_avespeed_pre_c +
    (1 | player) +
    (1 | gamenu) +
    (1 | section),
  data    = data_col356,
  family  = bernoulli(link = "logit"),
  prior   = priors_col5,
  chains  = 4, iter = 2000, warmup = 1000, cores = 4
)
saveRDS(m_col5_hier, "m_col5_hier.rds")
```

```{r}
summary(m_col5_hier)
pp_check(m_col5_hier, ndraws = 100)
conditional_effects(m_col5_hier, spaghetti = TRUE, ndraws = 200)
plot(m_col5_hier)
```

```{r}
m_col6_hier <- brm(
  dplagoal ~
    plaavspeed_c + playersprints_c +
    dhomegame + rank_gap_c +
    player_cumsections_c + player_cumsections_2_c +
    scoregap_pre_c + dteamgoal_pre + dplagoal_pre +
    dteamred_pre + dteaminj_sec_pre +
    team_avespeed_pre_c +
    (1 | player) +
    (1 | gamenu) +
    (1 | section),
  data    = data_col356,
  family  = bernoulli(link = "logit"),
  prior   = priors_col6,
  chains  = 4, iter = 2000, warmup = 1000, cores = 4
)
saveRDS(m_col6_hier, "m_col6_hier.rds")
```

```{r}
summary(m_col6_hier)
pp_check(m_col6_hier, ndraws = 100)
conditional_effects(m_col6_hier, spaghetti = TRUE, ndraws = 200)
plot(m_col6_hier)
```

```{r}
m_col7_hier <- brm(
  formula = goal_game ~
    plaavspeed_game_c + dhomegame + rank_gap_c +
    (1 | player) +
    (1 | gamenu),
  data    = data_col7,
  family  = bernoulli(link = "logit"),
  prior   = priors_col7,
  chains  = 4, iter = 2000, warmup = 1000, cores = 4
)
saveRDS(m_col7_hier, "m_col7_hier.rds")
```

```{r}
summary(m_col7_hier)
pp_check(m_col7_hier, ndraws = 100)
conditional_effects(m_col7_hier, spaghetti = TRUE, ndraws = 200)
plot(m_col7_hier)
```





```{r}
library(brms)
library(loo)
library(dplyr)
library(tidyr)
library(kableExtra)

## 1. Load all saved models -------------------------------------------
m_list <- list(
  `(1)` = readRDS("m_col1_hier.rds"),
  `(2)` = readRDS("m_col2_hier.rds"),
  `(3)` = readRDS("m_col3_hier.rds"),
  `(4)` = readRDS("m_col4_hier.rds"),
  `(5)` = readRDS("m_col5_hier.rds"),
  `(6)` = readRDS("m_col6_hier.rds"),
  `(7)` = readRDS("m_col7_hier.rds")
)

## 2. Helper to safely extract coefficient summaries -------------------

get_coef_summary <- function(m, coef_name) {
  fe <- fixef(m)
  if (!coef_name %in% rownames(fe)) {
    return(c(Estimate = NA, Est.Error = NA, Q2.5 = NA, Q97.5 = NA))
  } else {
    fe[coef_name, c("Estimate", "Est.Error", "Q2.5", "Q97.5")]
  }
}

## 3. Build summary table ----------------------------------------------

# we’ll assume these are the “effort” variables we care about
# (speed in cols 1–4 & 6, sprints in 5 & 6, game-level speed in 7)
model_summaries <- lapply(names(m_list), function(col_id) {
  m <- m_list[[col_id]]
  
  # N (number of observations used)
  N <- nobs(m)
  
  # main effort coefficients
  beta_speed     <- get_coef_summary(m, "plaavspeed_c")
  beta_sprints   <- get_coef_summary(m, "playersprints_c")
  beta_speed_g   <- get_coef_summary(m, "plaavspeed_game_c")
  
  # Bayes R² (mean and 90% CI)
  r2_draws <- bayes_R2(m)
  r2_mean  <- mean(r2_draws)
  r2_ci    <- quantile(r2_draws, probs = c(0.05, 0.95))
  
  # LOO & WAIC
  loo_out  <- loo(m)
  waic_out <- waic(m)
  
  looic  <- loo_out$estimates["looic", "Estimate"]
  waic   <- waic_out$estimates["waic", "Estimate"]
  
  tibble(
    Column = col_id,
    N      = N,
    
    # speed (section level)
    beta_speed      = beta_speed["Estimate"],
    se_speed        = beta_speed["Est.Error"],
    l95_speed       = beta_speed["Q2.5"],
    u95_speed       = beta_speed["Q97.5"],
    
    # sprints
    beta_sprints    = beta_sprints["Estimate"],
    se_sprints      = beta_sprints["Est.Error"],
    l95_sprints     = beta_sprints["Q2.5"],
    u95_sprints     = beta_sprints["Q97.5"],
    
    # game-level speed (col 7)
    beta_speed_game = beta_speed_g["Estimate"],
    se_speed_game   = beta_speed_g["Est.Error"],
    l95_speed_game  = beta_speed_g["Q2.5"],
    u95_speed_game  = beta_speed_g["Q97.5"],
    
    # Bayes R²
    R2_mean = r2_mean,
    R2_l90  = r2_ci[1],
    R2_u90  = r2_ci[2],
    
    # Fit criteria
    LOOIC = looic,
    WAIC  = waic
  )
})

table2_summary <- bind_rows(model_summaries)

## 4. Nicely formatted table (like Table 2 + extra stats) --------------

table2_summary %>%
  mutate(
    # optional: round for display
    across(
      c(beta_speed:WAIC),
      ~ round(., 3)
    )
  ) %>%
  kable(
    format = "latex", booktabs = TRUE,
    caption = "Bayesian hierarchical models corresponding to Table 2 (coefficients for effort variables, Bayes R², LOOIC, WAIC)."
  ) %>%
  kable_styling(latex_options = c("hold_position", "scale_down"))
```


# Table 3


## Add Team Names for table 3
```{r}
# add team names to the data for table 3
library(readxl)
team_names <- read_excel("TeamID.xlsx")


#teams don't play the same amount of games, there are 26 games in the first round then they are divided in top teams and bottom teams. isolate the 26 first games (Appendix A.2, in the paper) the regular season



# team rank in game 26 and game 27 because rank variable is the rank before the game

team_rank_r26 <- data %>%
  filter(played == 26) %>%           # only round 26
  distinct(team, team_rank)          # one row per team with its rank

team_rank_r27 <- data %>%
  filter(played == 27) %>%           # only round 27
  distinct(team, team_rank)          # one row per team with its rank

# compared with table "Positions by round" from https://en.wikipedia.org/wiki/2017%E2%80%9318_Israeli_Premier_League#Regular_season_table  -> team_rank_r27 is the right one

# add the israeli name to round 27
team_rank_r27 <- team_rank_r27 %>%
  left_join(
    team_names %>%
      select(team_rank, israeli_name = `händisch israeli name`),
    by = "team_rank"
  )

#add the israeli name to main data
data <- data %>%
  left_join(
    team_rank_r27 %>%
      select(team, israeli_name),
    by = "team"
  )

```


```{r}
##### First, aggregate on the team x game level #####

data_teamxgame <- data %>% 
  group_by(gamenu, team) %>%  
  summarise(
    teamdist_game = sum(teamdist_game, na.rm = TRUE),
    oppdist_game  = sum(oppdist_game,  na.rm = TRUE),
    dteamwin      = unique(dteamwin),     # same for all players on team
    team_crowd        = unique(team_crowd),
    opp_crowd         = unique(opp_crowd),
    rank_gap          = unique(rank_gap),
    dhomegame         = unique(dhomegame),
    danyteamredc_game = unique(danyteamredc_game),
    israeli_name      = unique(israeli_name),
    played            = unique(played)
  ) %>% 
  ungroup() %>%
  mutate(
    distance_ratio = teamdist_game / oppdist_game,
    total_distance = teamdist_game + oppdist_game
  ) %>%
  group_by(gamenu) %>%
  slice_min(israeli_name) %>%      # keep only the team which comes first in the hebrew alpahbet
  ungroup()
```

```{r}
# ---------- Create derived variables and center continuous regressors ----------
data_teamxgame <- data_teamxgame %>%
  mutate(
    distance_ratio = ifelse(is.na(distance_ratio), teamdist_game / ifelse(oppdist_game==0, NA, opp_dist),     distance_ratio),
    total_distance   = teamdist_game + oppdist_game,
    # center continuous predictors (mean-centering)
    teamdist_c = teamdist_game - mean(teamdist_game, na.rm = TRUE),
    oppdist_c  = oppdist_game  - mean(oppdist_game,  na.rm = TRUE),
    distance_ratio_c  = distance_ratio - mean(distance_ratio, na.rm = TRUE),
    total_distance_c  = total_distance - mean(total_distance, na.rm = TRUE),
    rank_gap_c   = rank_gap - mean(rank_gap, na.rm = TRUE),
    team_crowd_c = team_crowd - mean(team_crowd, na.rm = TRUE),
    opp_crowd_c  = opp_crowd - mean(opp_crowd, na.rm = TRUE)
  )

#datasets for each column 
table3_col1 <- data_teamxgame %>%
  drop_na(dteamwin, teamdist_game, oppdist_game)  

table3_col2 <- data_teamxgame %>%
  drop_na(dteamwin, teamdist_game, dhomegame, rank_gap)

table3_col3 <- data_teamxgame %>%
  drop_na(dteamwin, teamdist_game, dhomegame, rank_gap, team_crowd)

table3_col4 <- data_teamxgame %>%
  # restrict to games without red cards
  filter(is.na(danyteamredc_game) | danyteamredc_game == 0) %>%
  drop_na(dteamwin, teamdist_game, dhomegame, rank_gap)

table3_col5 <- data_teamxgame %>%
  drop_na(dteamwin, distance_ratio, dhomegame, rank_gap)

table3_col6 <- data_teamxgame %>%
  drop_na(dteamwin, distance_ratio, total_distance, dhomegame, rank_gap)

# double-check sample sizes
sapply(list(table3_col1, table3_col2, table3_col3, table3_col4, table3_col5, table3_col6), nrow)
```

slightly different sample sizes compared to the ones from table 3 in the paper (why?)

```{r}
#set weakly informative priors that fit logit scale 
priors_t3 <- c( 
set_prior("normal(0, 1)", class = "Intercept"), # 50% baseline chance angenommen, 95% masse in ca. [0.12, 0.88] 
set_prior("normal(0, 1)", class = "b", coef = "teamdist_c"),
set_prior("normal(0, 1)", class = "b", coef = "oppdist_c"),
set_prior("normal(0, 1)"))
```


```{r}
m_t3col1_prior <- brm( 
dteamwin ~ teamdist_c + oppdist_c + factor(played),
data = table3_col1, 
family = bernoulli(link = "logit"),
sample_prior = "only",
prior = priors_t3,
iter = 1000, warmup = 500, chains = 4, cores = 4 
)
```

```{r}
#prior checks
pp_check(m_t3col1_prior, ndraws = 50)          
yrep_small <- posterior_predict(m_t3col1_prior, ndraws = 100)
hist(rowMeans(yrep_small))
plot(m_t3col1_prior, N = 1000)                             
```

```{r}
m_t3col1 <- brm(
  dteamwin ~ teamdist_c + oppdist_c + factor(played),     
  data    = table3_col1,
  family  = bernoulli(link = "logit"),
  prior   = priors_t3,
  iter    = 4000, warmup = 2000, chains = 4, cores = 4
)
```

```{r}
summary(m_t3col1)
pp_check(m_t3col1, ndraws = 100)
conditional_effects(m_t3col1, spaghetti = TRUE, ndraws = 200)
plot(m_t3col1)
```

```{r}
cor(table3_col1 %>% select(teamdist_c, oppdist_c, distance_ratio_c, total_distance_c), use = "pairwise.complete.obs")
```

is multicollinearity causing problems here?

lets test for col 5
```{r}
priors_t3c5 <-c(
set_prior("normal(0, 0.5)",  class = "b", coef = "dhomegame"),
set_prior("normal(0, 0.05)", class = "b", coef = "rank_gap_c"),
set_prior("normal(0, 5)", class = "b", coef = "distance_ratio_c")
)
```


```{r}
m_t3col5 <- brm(
  dteamwin ~ distance_ratio_c + 
  dhomegame +
  rank_gap_c +
  factor(played),     
  data    = table3_col1,
  family  = bernoulli(link = "logit"),
  prior   = priors_t3c5,
  iter    = 4000, warmup = 2000, chains = 4, cores = 4,
  control = list(max_treedepth = 15, adapt_delta = 0.95) #increase treedepth to avoid problems during warmup
)
```




